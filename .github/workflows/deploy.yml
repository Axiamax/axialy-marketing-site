name: Deploy

on:
  push:
    branches: [ main ]

jobs:
  deploy:
    runs-on: ubuntu-latest
    env:
      DROPLET: axialy-main
      REGION: nyc3
      IMAGE: ubuntu-24-04-x64
      SIZE: s-1vcpu-1gb

    steps:
    - name: Checkout
      uses: actions/checkout@v3

    - name: Install doctl
      run: |
        curl -sSL https://github.com/digitalocean/doctl/releases/latest/download/doctl-linux-amd64.tar.gz \
          | sudo tar -xz -C /usr/local/bin doctl

    - name: Authenticate doctl
      run: doctl auth init -t ${{ secrets.DO_TOKEN }}

    - name: Import SSH key (idempotent)
      run: |
        echo "${{ secrets.SSH_PUB }}" > /tmp/deploy_key.pub
        if ! doctl compute ssh-key list --format FingerPrint --no-header \
             | grep -qx "${{ secrets.SSH_FP }}"; then
          doctl compute ssh-key import deploy_key \
            --public-key-file /tmp/deploy_key.pub \
            --fingerprint "${{ secrets.SSH_FP }}"
        fi

    - name: Ensure droplet exists
      run: |
        if ! doctl compute droplet list --format Name --no-header \
             | grep -qx "$DROPLET"; then
          doctl compute droplet create "$DROPLET" \
            --region "$REGION" \
            --image  "$IMAGE" \
            --size   "$SIZE" \
            --ssh-keys "${{ secrets.SSH_FP }}" \
            --wait
        fi

    - name: Fetch droplet IP
      id: get_ip
      run: |
        IP=$(doctl compute droplet list "$DROPLET" \
             --format PublicIPv4 --no-header | head -n1)
        echo "ip=$IP" >> $GITHUB_OUTPUT

    - name: Write private key
      run: |
        echo "${{ secrets.SSH_PRIVATE_KEY }}" > /tmp/deploy_key
        chmod 600 /tmp/deploy_key

    - name: Deploy via SSH
      uses: appleboy/ssh-action@v0.1.7
      with:
        host:       ${{ steps.get_ip.outputs.ip }}
        username:   root
        key_path:   /tmp/deploy_key
        passphrase: ${{ secrets.SSH_PASSPHRASE }}
        strict:     false
        script: |
          set -e
          apt-get update
          apt-get install -y git
          mkdir -p /var/www/html
          cd /var/www/html
          if [ -d .git ]; then
            git pull
          else
            git clone https://github.com/Axiamax/axialy-marketing-site .
          fi
